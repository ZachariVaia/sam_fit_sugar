# `sam_fit_sugar` Detailed Technical Documentation

## Table of Contents

1. [Introduction](#introduction)
2. [System Architecture](#system-architecture)

   * [SAM2 Component](#sam2-component)
   * [SuGaR Component](#sugar-component)
3. [Pipeline Workflow](#pipeline-workflow)

   * [Step 1: Image Input](#step-1-image-input)
   * [Step 2: Point Annotation](#step-2-point-annotation)
   * [Step 3: SAM2 Mask Generation](#step-3-sam2-mask-generation)
   * [Step 4: 3D Reconstruction with SuGaR](#step-4-3d-reconstruction-with-sugar)
4. [Installation Guide](#installation-guide)

   * [System Requirements](#system-requirements)
   * [Installation Instructions](#installation-instructions)
5. [Dataset Preparation](#dataset-preparation)

   * [Directory Structure](#directory-structure)
   * [Image Format Specifications](#image-format-specifications)
6. [Environment Variables](#environment-variables)

   * [SAM_FIT_SUGAR_PATH](#sam_fit_sugar_path)
7. [Pipeline Execution](#pipeline-execution)

   * [Running the Pipeline](#running-the-pipeline)
8. [SAM2 and SuGaR Integration](#sam2-and-sugar-integration)

   * [SAM2 Functionality Breakdown](#sam2-functionality-breakdown)
   * [SuGaR Functionality Breakdown](#sugar-functionality-breakdown)
9. [Mask Generation and Object Isolation](#mask-generation-and-object-isolation)

   * [Point Annotation and Image Masking](#point-annotation-and-image-masking)
   * [Mask Refinement Process](#mask-refinement-process)
10. [3D Reconstruction with SuGaR](#3d-reconstruction-with-sugar)

    * [Gaussian Splatting Process](#gaussian-splatting-process)
    * [Mesh Construction and Refinement](#mesh-construction-and-refinement)
11. [Limitations and Known Issues](#limitations-and-known-issues)
12. [Future Improvements](#future-improvements)

    * [Automated Point Annotation](#automated-point-annotation)
    * [Advanced 3D Reconstruction Techniques](#advanced-3d-reconstruction-techniques)
13. [Conclusion](#conclusion)
14. [Technical Details](#technical-details)

    * [SAM2-Docker CUDA Version](#sam2-docker-cuda-version)
    * [SuGaR CUDA Version](#sugar-cuda-version)
    * [Docker Setup and Configuration](#docker-setup-and-configuration)

---

## Introduction

`sam_fit_sugar` is a computational framework designed for processing images and generating clean, background-free 3D models. The system is built around two major components: **SAM2** (Surface-Aligned Mesh) for image segmentation and **SuGaR** (Surface-Aligned Gaussian Splatting) for 3D model creation. By combining these technologies, `sam_fit_sugar` efficiently isolates objects from background noise and converts them into high-quality, detailed 3D models, making it ideal for applications in medical imaging, computer vision, and augmented reality.

---

## System Architecture

### SAM2 Component

**SAM2** is a critical module in the pipeline responsible for isolating the object of interest from the background of a 2D image. This segmentation is performed by annotating key points on the image and using these points to generate a binary mask.

* **Point Annotation**: The user interacts with the image by left- and right-clicking to define regions of interest. Positive points (object area) are marked with green, and negative points (background area) are marked with red.

* **Mask Generation**: SAM2 computes the mask using the annotated points. The algorithm employs **region-growing** techniques and **edge detection** to refine the object isolation from the background.

  * **Mask Generation Algorithm**:

    * Start by creating a **seed region** from the positive points.
    * Use a **flood-fill** or **region-growing** algorithm to extend this region, progressively incorporating neighboring pixels based on color or intensity similarity.
    * Once the region reaches the defined boundaries, the mask is complete.

* **Data Structures**:

  * **Points**: Each annotation (positive and negative) is stored as a coordinate pair (`x, y`) in a list.
  * **Mask**: The output mask is a binary 2D array, where each pixel is either `1` (foreground) or `0` (background).

---

### SuGaR Component

**SuGaR** takes the binary mask from SAM2 and performs 3D reconstruction using **Gaussian splatting**. The primary goal of SuGaR is to create a 3D mesh that accurately represents the isolated object.

* **Point Cloud Generation**: Using the mask generated by SAM2, each pixel in the mask is treated as a 3D point in the object’s surface. This point cloud forms the initial representation of the object.

* **Gaussian Splatting**: For each point, a **Gaussian distribution** is applied, effectively creating a "cloud" of splats that represent the surface of the object. This allows for better handling of continuous surfaces and subpixel accuracy.

* **Mesh Refinement**: The splats are aggregated and refined to form a continuous 3D surface. This is done using techniques such as **Poisson surface reconstruction** or **marching cubes**.

* **Data Structures**:

  * **Point Cloud**: A list of 3D points, each represented by coordinates (`x, y, z`).
  * **Gaussian Splats**: Each point in the cloud is expanded into a Gaussian splat. The splats are stored with properties like position, radius, and intensity.
  * **Mesh**: The final output is stored as a collection of vertices and faces.

---

## Pipeline Workflow

### Step 1: Image Input

The pipeline begins by accepting 2D images as input. The system supports `.jpg` format, ensuring ease of use with typical photographic datasets.

* **Image Preprocessing**: Images are resized (if necessary) to match the required resolution for the model and to reduce computational load. The preprocessing step also normalizes image brightness and contrast to enhance feature detection.

### Step 2: Point Annotation

The user is prompted to annotate the image by selecting points of interest:

* **Positive Points**: Left-click to indicate the object of interest.
* **Negative Points**: Right-click to mark the background.

These annotations provide the foundation for generating the segmentation mask.

### Step 3: SAM2 Mask Generation

Once the points are annotated, SAM2 uses a **flood-fill algorithm** to expand the positive region based on pixel similarity. The system iteratively adds neighboring pixels to the object region, using boundary conditions defined by the negative points.

* **Mask Refinement**: SAM2 also applies a **contour refinement algorithm** to ensure that the boundaries of the object are as accurate as possible.

* **Output**: A binary mask is created, isolating the object from the background. This mask is saved as a 2D array of binary values (`1` for object, `0` for background).

### Step 4: 3D Reconstruction with SuGaR

* **Point Cloud Creation**: Each pixel in the binary mask is treated as a point in 3D space. The resolution of the mask determines the resolution of the point cloud.

* **Gaussian Splatting**: For each point in the cloud, a Gaussian splat is created. These splats help model the object's surface with subpixel accuracy, smoothing over any potential irregularities in the initial point cloud.

* **Mesh Construction**: After applying the splats, the system uses **surface reconstruction algorithms** to convert the splats into a 3D mesh. This step includes techniques like **Poisson surface reconstruction** or **Marching Cubes**, which convert the sparse point cloud into a solid 3D object.

---

## Installation Guide

### System Requirements

* **Docker**: Used for containerized execution of SAM2 and SuGaR.
* **Python**: Python 3.x is required to manage dependencies and execute the pipeline scripts.
* **Memory**: Ensure at least 8GB of RAM for image processing and reconstruction tasks.
* **Disk Space**: 10GB free space is recommended to store images and generated models.

### Installation Instructions

1. **Clone the `sam_fit_sugar` Repository**:

   ```bash
   git clone https://gitlab.com/ilsp-xanthi-medialab/textailes/wp4/t4.5/sam_fit_sugar.git
   cd sam_fit_sugar
   ```

2. **Clone SAM2-Docker**:

   ```bash
   git clone https://github.com/peasant98/SAM2-Docker.git
   cd SAM2-Docker
   ```

3. **Clone SuGaR**:

   ```bash
   git clone https://github.com/Anttwo/SuGaR.git
   cd SuGaR
   ```

4. **Install Dependencies**:

   ```bash
   pip install -r requirements.txt
   ```

5. **Docker Setup**:

   * Ensure that Docker is installed and running. Build the containers for SAM2 and SuGaR if needed using the provided Dockerfiles.

---

## Dataset Preparation

### Directory Structure

To ensure proper dataset handling, follow the structure below:

```
SAM2-Docker/
├── data/
│   └── your_dataset_name/
│       ├── image1.jpg
│       ├── image2.jpg
│       └── ...
```

### Image Format Specifications

* **Input Format**: Only `.jpg` files are supported. Other image formats will not work correctly.
* **Resolution**: Images should be at least 1080p resolution to maintain sufficient detail for the segmentation process.

---

## Environment Variables

Set the following environment variable to ensure proper functioning of the system:

```bash
export SAM_FIT_SUGAR_PATH="/path/to/SAM_FIT_SUGAR_PATH"
```

Replace `"/path/to/SAM_FIT_SUGAR_PATH"` with the actual path where the repository is located on your system.

---

## Pipeline Execution

### Running the Pipeline

1. After setting up the dataset and environment, execute the pipeline with:

```bash
cd ..
./run_pipeline.sh your_dataset_name
```

This command will:

* Process the images and create masks using SAM2.
* Use the generated masks to reconstruct the 3D model using SuGaR.

---

## SAM2 and SuGaR Integration

### SAM2 Functionality Breakdown

* **Point Annotation**: The core of SAM2 relies on the accuracy of point annotation. The system uses these points to generate an initial object boundary.
* **Flood-fill Algorithm**: The region-growing algorithm extends from the seed points to isolate the object.

### SuGaR Functionality Breakdown

* **Point Cloud Generation**: Each point in the mask corresponds to a 3D point.
* **Gaussian Splatting**: Each point is turned into a Gaussian splat to create smooth surfaces.
* **Surface Reconstruction**: The splats are aggregated to form a continuous 3D mesh.

---

## Mask Generation and Object Isolation

### Point Annotation and Image Masking

* **Left-click**: Add positive points for the object.
* **Right-click**: Add negative points for the background.

This step is essential for defining the boundaries of the object for subsequent steps in the pipeline.

### Mask Refinement Process

SAM2 refines the mask by adjusting its boundaries and filling in gaps. The refinement algorithm uses **region-growing** and **boundary refinement** techniques.

---

## 3D Reconstruction with SuGaR

### Gaussian Splatting Process

* **Gaussian Splat**: Each point in the point cloud is converted into a Gaussian distribution.
* **Splat Aggregation**: These splats are aggregated to form the object’s surface, using a density function to merge overlapping splats.

### Mesh Construction and Refinement

After generating the splats, SuGaR refines the surface using **Poisson surface reconstruction** or **Marching Cubes**, ensuring that the final 3D mesh is smooth and continuous.

---

## Limitations and Known Issues

* **Accuracy of Annotations**: The accuracy of the final 3D model depends heavily on the precision of the user’s annotations.
* **Background Complexity**: The system may struggle with very complex backgrounds or similar object-background contrasts.

---

## Future Improvements

### Automated Point Annotation

Plans for future versions include an automatic point detection system that uses machine learning to detect key points, minimizing user interaction.

### Advanced 3D Reconstruction Techniques

We aim to integrate advanced techniques such as **texture mapping**, **fine-grained mesh refinement**, and **dynamic 3D reconstruction** for more complex geometries.

---

## Conclusion

`sam_fit_sugar` offers a robust framework for background-free 3D reconstruction. By combining the segmentation power of SAM2 with the 3D modeling capabilities of SuGaR, this system provides an efficient solution for generating high-quality 3D models from 2D images.

---

## Technical Details

### SAM2-Docker CUDA Version

**SAM2-Docker** is designed to run on systems with NVIDIA GPUs that support **CUDA**. To ensure efficient execution, the following CUDA versions are supported:

1. **CUDA 12.1**: This version of the Docker image supports the latest CUDA toolkit, providing the best performance for image segmentation tasks.

   * To run with CUDA 12.1:

     ```bash
     docker run -it -v /tmp/.X11-unix:/tmp/.X11-unix  -e DISPLAY=$DISPLAY --gpus all peasant98/sam2:cuda-12.1 bash
     ```

2. **CUDA 12.6**: If you have a system with support for CUDA 12.6, you can use that version for improved performance.

   * To run with CUDA 12.6:

     ```bash
     docker run -it -v /tmp/.X11-unix:/tmp/.X11-unix  -e DISPLAY=$DISPLAY --gpus all peasant98/sam2:latest bash
     ```

3. **NVIDIA Container Toolkit**: Ensure that the **NVIDIA Container Toolkit** is installed to use GPU acceleration:

   ```bash
   sudo apt-get install -y nvidia-docker2
   sudo systemctl restart docker
   ```

### SuGaR CUDA Version

**SuGaR** also leverages **CUDA** for faster Gaussian splatting and mesh reconstruction tasks. It supports the same versions of CUDA (11.x+) as SAM2.

* **CUDA 12.1/12.6**: Ensure your system supports the corresponding CUDA version for best performance. Both CUDA 12.1 and 12.6 are fully supported.

---

### Docker Setup and Configuration

1. **Install NVIDIA Docker**:
   First, install **NVIDIA Docker** for GPU support in Docker containers.

   ```bash
   distribution=$(. /etc/os-release;echo $ID$VERSION_ID) \
     && curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add - \
     && curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list
   sudo apt-get update
   sudo apt-get install -y nvidia-docker2
   sudo systemctl restart docker
   ```

2. **Run Containers**:
   You can now run both **SAM2** and **SuGaR** with GPU support:

   ```bash
   docker run -it -v /tmp/.X11-unix:/tmp/.X11-unix -e DISPLAY=$DISPLAY --gpus all peasant98/sam2:latest bash
   ```

3. **Building Custom Docker Images**:
   If you need to customize Docker configurations, build your own image:

   ```bash
   docker build -t sam2:latest .
   docker run -it -v /tmp/.X11-unix:/tmp/.X11-unix -e DISPLAY=$DISPLAY --gpus all sam2:latest bash
   ```

